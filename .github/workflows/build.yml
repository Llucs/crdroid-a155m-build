name: crDroid A15 - SUICIDE RUN V2

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

env:
  DEVICE: a15
  LUNCH: crdroid_a15-userdebug
  # Configura√ß√µes extremas para evitar OOM (Out of Memory)
  _JAVA_OPTIONS: "-Xmx8g"
  USE_CCACHE: 1
  CCACHE_COMPRESS: 1
  CCACHE_MAXSIZE: 30G

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 340 # Deixei margem de seguran√ßa para o upload

    steps:
      # 1. PREPARA√á√ÉO DO TERRENO (LVM + LIMPEZA)
      - name: ‚ò¢Ô∏è Nuke & Repartition (Maximize Space)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 14336 # 14GB Swap (M√°ximo seguro)
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          overprovision-lvm: 'true'

      # 2. INSTALA√á√ÉO DE FERRAMENTAS (R√ÅPIDA)
      - name: ‚ö° Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
            x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig python3 python-is-python3 \
            libncurses5 rsync ccache jq bc
          
          # ANDROID 15 PRECISA DE JAVA 21!
          sudo apt-get install -y openjdk-21-jdk
          java -version

      # 3. SETUP DO REPO
      - name: üì• Setup Repo Tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
          
          git config --global user.name "LucasBuilder"
          git config --global user.email "bot@localhost"
          git config --global color.ui false

      # 4. INICIALIZA√á√ÉO E SYNC (PARCIAL)
      - name: üå± Repo Init & Sync
        run: |
          mkdir crdroid
          cd crdroid
          
          # Inicializa APENAS o necess√°rio. Android 15 √© enorme.
          repo init -u https://github.com/crdroidandroid/android.git -b 15.0 --depth=1 --no-tags --groups=all,-notdefault,-device,-darwin,-x86,-mips
          
          # Injeta manifesto local
          mkdir -p .repo/local_manifests
          curl -L https://raw.githubusercontent.com/Llucs/android_local_manifests/main/a15.xml -o .repo/local_manifests/a15.xml
          
          # Sincroniza. Se falhar um pacote, tenta continuar.
          repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j$(nproc) || true

      # 5. O GRANDE CORTE (LIBERAR 40GB+)
      - name: ü™ì Delete .repo & Junk
        run: |
          cd crdroid
          echo "Deletando hist√≥rico git..."
          rm -rf .repo
          
          echo "Deletando hardwares in√∫teis..."
          rm -rf device/generic/opengl-transport
          rm -rf device/google/cuttlefish*
          rm -rf device/google/trout*
          rm -rf packages/apps/FMRadio
          # Remove clang prebuilts antigos se existirem, mantendo apenas o mais recente
          # (Isso √© arriscado, mas necess√°rio)
          
          df -h

      # 6. COMPILA√á√ÉO (MODO BATALHA)
      - name: üöÄ BUILD (Bacon)
        run: |
          cd crdroid
          source build/envsetup.sh
          
          # Tenta o lunch
          lunch $LUNCH || lunch crdroid_a15-ap2a-userdebug
          
          # Vari√°veis para pular verifica√ß√µes chatas que comem tempo/disco
          export BUILD_USERNAME="Lucas"
          export BUILD_HOSTNAME="GitHub-Runner"
          export KBUILD_BUILD_USER="Lucas"
          export KBUILD_BUILD_HOST="GitHub-Runner"
          
          # DESATIVA TUDO QUE √â IN√öTIL
          export WITHOUT_CHECK_API=true
          export SKIP_ABI_CHECKS=true
          export SKIP_BOOT_JARS_CHECK=true
          export BOARD_EXT4_SHARE_DUP_BLOCKS=true
          export BUILD_BROKEN_MISSING_REQUIRED_MODULES=true
          export BUILD_BROKEN_USES_BUILD_COPY_HEADERS=true
          export BUILD_BROKEN_DUP_RULES=true
          export BUILD_BROKEN_ELF_PREBUILT_PRODUCT_COPY_FILES=true
          
          # MKA BACON
          # Usamos o comando mka (otimizado) ao inv√©s de make
          mka bacon -j$(nproc) || true

      # 7. EXFILTRA√á√ÉO DO ARQUIVO (GOFILE)
      - name: ‚òÅÔ∏è Upload to GoFile (Critical)
        run: |
          cd crdroid/out/target/product/$DEVICE
          
          # Procura qualquer zip gerado
          ZIP=$(find . -maxdepth 1 -name "crDroid*.zip" | head -n 1)
          
          if [ -z "$ZIP" ]; then
            echo "‚ùå BUILD FALHOU - NENHUM ZIP ENCONTRADO"
            ls -R
            exit 1
          fi
          
          echo "‚úÖ ZIP ENCONTRADO: $ZIP"
          
          # Tenta upload em m√∫ltiplos servidores
          curl -F "file=@$ZIP" https://store1.gofile.io/uploadFile || \
          curl -F "file=@$ZIP" https://store2.gofile.io/uploadFile || \
          curl -F "file=@$ZIP" https://store3.gofile.io/uploadFile

      # 8. ARTIFACTS (BACKUP)
      - name: üì¶ Upload to GitHub Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: crDroid-A15-Logs-And-Build
          path: |
            crdroid/out/target/product/${{ env.DEVICE }}/*.zip
            crdroid/out/error.log
          retention-days: 1
