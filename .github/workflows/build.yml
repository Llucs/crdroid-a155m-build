name: crDroid A15 Full Build

on:
  workflow_dispatch:

env:
  DEVICE: a15
  LUNCH: crdroid_a15-userdebug
  CCACHE_DIR: /tmp/ccache
  USE_CCACHE: 1

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    steps:
      - name: Free disk space (aggressive)
        run: |
          sudo rm -rf /usr/share/dotnet \
                      /usr/local/lib/android \
                      /opt/ghc \
                      /opt/hostedtoolcache
          sudo docker system prune -af
          df -h

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git-core gnupg flex bison build-essential zip curl \
            zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
            lib32ncurses5-dev x11proto-core-dev libx11-dev \
            lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc \
            unzip fontconfig python-is-python3 openjdk-17-jdk

      - name: Init repo
        run: |
          mkdir crdroid
          cd crdroid
          repo init \
            -u https://github.com/crdroidandroid/android.git \
            -b 15.0 \
            --depth=1 \
            --no-tags

          mkdir -p .repo/local_manifests
          curl -L https://raw.githubusercontent.com/Llucs/android_local_manifests/main/a15.xml \
            -o .repo/local_manifests/a15.xml

      - name: Repo sync (conservative)
        run: |
          cd crdroid
          repo sync -c \
            --no-clone-bundle \
            --no-tags \
            --optimized-fetch \
            -j4

      - name: Prepare build env
        run: |
          cd crdroid
          source build/envsetup.sh
          lunch $LUNCH
          export JOBS=$(nproc)
          echo "Using $JOBS threads"

      - name: Clean trash before build
        run: |
          cd crdroid
          rm -rf out/target/product/*/obj
          df -h

      - name: Build FULL ROM ZIP
        run: |
          cd crdroid
          source build/envsetup.sh
          lunch $LUNCH

          # Flags pra reduzir lixo
          export WITHOUT_CHECK_API=true
          export BUILD_WITHOUT_OTA=true
          export TARGET_BUILD_VARIANT=userdebug

          mka bacon -j$(nproc)

      - name: Verify output
        run: |
          ls -lh crdroid/out/target/product/$DEVICE || true
          test -f crdroid/out/target/product/$DEVICE/*.zip

      - name: Upload ROM to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: crDroid-A15-FULL
          path: crdroid/out/target/product/a15/*.zip
          retention-days: 7

      - name: Upload ROM to GoFile (mirror)
        if: success()
        run: |
          cd crdroid/out/target/product/a15
          ZIP=$(ls *.zip | head -n1)
          echo "Uploading $ZIP to GoFile"
          curl -F "file=@$ZIP" https://store1.gofile.io/uploadFile