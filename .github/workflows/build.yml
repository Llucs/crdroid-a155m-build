Name: crDroid A15 - SUICIDE RUN

on:
  workflow_dispatch:

env:
  # Dados do dispositivo
  DEVICE: a15
  LUNCH: crdroid_a15-userdebug
  # Otimiza√ß√µes de compila√ß√£o
  USE_CCACHE: 1
  CCACHE_SIZE: 50G
  CCACHE_DIR: /tmp/ccache
  CCACHE_EXEC: /usr/bin/ccache
  # For√ßar Java correto para Android 15
  JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

jobs:
  build:
    runs-on: ubuntu-22.04 # 22.04 √© mais est√°vel para hacks de parti√ß√£o que o 24.04
    timeout-minutes: 360 # 6 horas √© o limite m√°ximo do GitHub hardcoded

    steps:
      # 1. O HACK DE ESPA√áO: Funde parti√ß√µes e remove softwares in√∫teis
      - name: ‚ò¢Ô∏è Maximize Build Space (LVM Hack)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 12288 # 12GB Swap (Crucial para n√£o dar erro de mem√≥ria)
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      # 2. Verificar se o hack funcionou
      - name: üîç Check Disk & Memory
        run: |
          echo "Disk Space:"
          df -h
          echo "Memory & Swap:"
          free -h
          echo "CPU Cores:"
          nproc

      # 3. Instalar depend√™ncias essenciais (Sem lixo)
      - name: üõ†Ô∏è Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
            x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig python3 python-is-python3 \
            openjdk-17-jdk libncurses5 rsync ccache jq

      # 4. Configurar Git e Repo
      - name: ‚öôÔ∏è Configure Git
        run: |
          git config --global user.name "LucasBot"
          git config --global user.email "lucasbot@localhost"
          git config --global color.ui false
          # Otimiza√ß√£o de rede
          git config --global http.postBuffer 1048576000

      # 5. Baixar ferramenta Repo
      - name: üì• Install Repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      # 6. Inicializar Repo (Android 15)
      - name: üå± Repo Init
        run: |
          mkdir crdroid
          cd crdroid
          repo init -u https://github.com/crdroidandroid/android.git -b 15.0 --depth=1 --no-tags --groups=all,-notdefault,-device,-darwin,-x86,-mips

      # 7. Injetar Manifesto Local
      - name: üíâ Inject Local Manifest
        run: |
          cd crdroid
          mkdir -p .repo/local_manifests
          # Baixa o manifesto direto. Se falhar, o build para aqui.
          curl -L https://raw.githubusercontent.com/Llucs/android_local_manifests/main/a15.xml -o .repo/local_manifests/a15.xml
          cat .repo/local_manifests/a15.xml

      # 8. Repo Sync (Agressivo)
      - name: üîÑ Repo Sync
        run: |
          cd crdroid
          # -j$(nproc) usa todos os n√∫cleos. --force-sync sobrescreve erros.
          repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j$(nproc)

      # 9. O GRANDE EXPURGO (Kamikaze)
      # Deleta a pasta .repo (git history) para liberar ~40GB de espa√ßo para o build.
      # Deleta pastas de emuladores e arquiteturas in√∫teis.
      - name: üóëÔ∏è DELETE .REPO & Unused Sources
        run: |
          cd crdroid
          echo "Tamanho antes do expurgo:"
          du -sh .
          
          echo "Deletando hist√≥rico do Git (.repo)... Sem volta."
          rm -rf .repo
          
          echo "Deletando fontes in√∫teis para economizar espa√ßo..."
          rm -rf device/generic/opengl-transport
          rm -rf device/google/cuttlefish*
          rm -rf device/google/trout*
          rm -rf device/linaro
          # Se o A15 for Mediatek/Exynos, podemos limpar coisas da Qualcomm (qcom) se n√£o forem deps globais
          # Mas √© arriscado, ent√£o manteremos o b√°sico.
          
          echo "Tamanho ap√≥s expurgo:"
          du -sh .
          df -h

      # 10. Configurar CCACHE (Local, vol√°til)
      - name: ‚ö° Setup Ccache
        run: |
          export USE_CCACHE=1
          export CCACHE_EXEC=/usr/bin/ccache
          ccache -M 30G
          ccache -o compression=true
          ccache -z

      # 11. O BUILD (Tudo ou Nada)
      - name: üöÄ BUILD ROM
        run: |
          cd crdroid
          source build/envsetup.sh
          
          # Tenta configurar o lunch. Se falhar, tenta o nome gen√©rico.
          lunch $LUNCH || lunch crdroid_a15-ap2a-userdebug
          
          # Vari√°veis para evitar verifica√ß√µes lentas e erros de API
          export KBUILD_BUILD_USER="Lucas"
          export KBUILD_BUILD_HOST="Github-CI"
          export BUILD_USERNAME="Lucas"
          export BUILD_HOSTNAME="Github-CI"
          export WITHOUT_CHECK_API=true
          export BOARD_EXT4_SHARE_DUP_BLOCKS=true # Economiza espa√ßo na imagem
          export SKIP_ABI_CHECKS=true
          
          # Tenta compilar. Se der erro, continua para tentar pegar logs.
          # Usamos 'mka bacon' como pedido, mas se falhar por espa√ßo, nada feito.
          mka bacon -j$(nproc) || true

      # 12. Encontrar o arquivo (mesmo que o nome varie)
      - name: üïµÔ∏è Find Output
        id: find_zip
        run: |
          cd crdroid/out/target/product/$DEVICE
          echo "Conte√∫do da pasta out:"
          ls -lah
          
          # Pega qualquer ZIP que pare√ßa uma ROM
          ZIP_PATH=$(find . -maxdepth 1 -name "crDroid*.zip" | head -n 1)
          
          if [ -z "$ZIP_PATH" ]; then
            echo "Nenhum ZIP encontrado. Build falhou."
            exit 1
          else
            echo "ZIP encontrado: $ZIP_PATH"
            echo "zip_path=$ZIP_PATH" >> $GITHUB_OUTPUT
          fi

      # 13. Upload para GoFile (Backup Imediato)
      # Artifacts demoram para processar, GoFile √© instant√¢neo.
      - name: ‚òÅÔ∏è Upload to GoFile
        if: steps.find_zip.outputs.zip_path != ''
        run: |
          cd crdroid/out/target/product/$DEVICE
          ZIP_NAME=$(basename ${{ steps.find_zip.outputs.zip_path }})
          echo "Enviando $ZIP_NAME para GoFile..."
          
          # Tenta servidor aleat√≥rio do GoFile (API din√¢mica)
          SERVER=$(curl -s https://api.gofile.io/getServer | jq -r '.data.server')
          curl -F "file=@$ZIP_NAME" "https://$SERVER.gofile.io/uploadFile"

      # 14. Upload Artifacts (Se sobrar tempo/espa√ßo)
      - name: üì¶ Upload Artifact
        if: steps.find_zip.outputs.zip_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: crDroid-A15-Build
          path: crdroid/out/target/product/${{ env.DEVICE }}/*.zip
          retention-days: 3
